<!-- TeamCity.html -->
<!-- Created by Carol Clark on 2016 Nov 28 for repository Support. -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>TeamCity</title>
	<link rel="stylesheet" type="text/css" href="../css/technical.css" />
</head>
<body>
<div class='navhead' id='Top'><table class='navhead'><col class='navhead_c1' /><tr>
	<td>[<a href="../Support/Support.html">Support</a>]</td>
	<td class='right'>[<a href="#Contents">Contents</a>]</td></tr></table></div>
<h1>TeamCity</h1>

<!-- @topicList "TeamCity" "Contents" -->
	<!-- @topicItem "Install and Configure TeamCity Server" "#InstallConfig_" "0" "" -->
		<!-- @topicItem "Provide Dependencies" "#ProvideDependencies_" "1" "includes MySQL" -->
		<!-- @topicItem "Install TeamCity Server" "#InstallTeamCityServer_" "1" "" -->
		<!-- @topicItem "Start TeamCity Server" "#StartTeamCityServer_" "1" "" -->
		<!-- @topicItem "Create TeamCityDB" "#CreateTeamCityDB_" "1" "" -->
		<!-- @topicItem "Integrate MySQL and TeamCity Servers" "#IntegrateMySQLandTeamCityServers_" "1" "" -->
		<!-- @topicItem "Run TeamCity WebApp and Configure" "#RunTeamCityWebApp_" "1" "" -->
		<!-- @topicItem "Install Build Agent" "#InstallBuildAgent_" "1" "" -->
		<!-- @topicItem "Store Project Settings in Version Control" "#StoreProjectSettingsinVCS_" "1" "" -->
	<!-- @topicGroup "" "9" -->
	<!-- @topicItem "TeamCity Tasks" "#TeamCityTasks_" "0" "" -->
		<!-- @topicItem "Moving to Another Server" "#MovingServer_" "1" "" -->
		<!-- @topicItem "Uninstall TeamCity" "#UninstallTeamCity_" "1" "" -->
	<!-- @topicGroup "References" "14" -->
	<!-- @topicItem "Build Script Interaction with TeamCity" "https://confluence.jetbrains.com/display/TCD10/Build+Script+Interaction+with+TeamCity" "0" "additional control for builds" -->
	<!-- @topicItem "Install and Configure the TeamCity Server" "https://confluence.jetbrains.com/display/TCD10/Installing+and+Configuring+the+TeamCity+Server" "0" "contents page" -->
	<!-- @topicItem "TeamCity Server icon" "https://hub.docker.com/r/jetbrains/teamcity-server/" "0" "" -->
<!-- @/topicList -->

<!-- @marker "InstallConfig_" -->
<h3 id='InstallConfig_'>Install and Configure TeamCity</h3>

	<!-- @marker "Provide Dependencies" -->
	<h4 id='ProvideDependencies_'>Provide Dependencies; includes MySQL</h4><ul>
		<li>install or check for updates as indicated:<ul>
			<li class="blurb">see also<a href="https://confluence.jetbrains.com/display/TCD10/Supported+Platforms+and+Environments">
				Supported Platforms and Environments</a></li>
			<li><a href="Tools.html#_gnutar">gnu-tar</a>; execute with <span class="mono">gtar</span></li>
			<li><a href="Tools.html#_Java">Java</a></li>
			<li><a href="MySQL.html#InstallandSetUpMySQL_">MySQL</a></li>
		</ul></li>
		<li>if necessary, <a href="MySQL.html#InstallandSetUpMySQL_">Install and Set Up MySQL</a><ul>
			<li>includes install; initialize data directory; test; secure initial accounts</li>
		</ul></li>
	</ul>

	<!-- @marker "Install TeamCity Server" -->
	<h4 id='InstallTeamCityServer_'>Install TeamCity Server</h4><ul>
		<li class="blurb">see <a href="https://confluence.jetbrains.com/display/TCD10/Installing+and+Configuring+the+TeamCity+Server">
			Installing and Configuring the TeamCity Server</a></li>
		<li>download from <a href="https://www.jetbrains.com/teamcity/download/">TeamCity downloads</a></li>
		<li>move archive to /Library/; archive location will become TeamCity home directory</li>
		<li>Terminal:<ul>
			<li>cd /Library</li>
			<li>unzip using gnu-tar: <span class="mono">sudo gtar xf &lt;archive&gt;</span></li>
		</ul></li>
		<li>if directory /Library/TeamCity/logs does not exist, create it</li>
	</ul>

	<!-- @marker "Start TeamCity Server" -->
	<h4 id='StartTeamCityServer_'>Start TeamCity Server</h4><ul>
		<li>Start TeamCity Server<ul>
			<li class="blurb"><span style="color: crimson">WARNING</span>: do not enter this web application yet</li>
			<li>open http://localhost.8111; will not show content yet</li>
			<li><em>check/update path before running</em> <span class="mono">cd /Library/TeamCity; teamcity-server.sh start</span><ul>
				<li class="blurb">should show short log in Terminal, TeamCity startup window at localhost:8111</li>
			</ul></li>
		</ul></li>
		<li>Autostart TeamCity Server<ul>
			<li>create AutoStart file ~/Dev/Support/Developer/Developer/Developer/JetBrains/jetbrains.teamcity.server.plist as specified in
				<a href="https://confluence.jetbrains.com/display/TCD6/Autostart+TeamCity+on+Mac">Autostart TeamCity on Mac</a></li>
			<li>add user to autostart file:<span class="mono">&lt;key&gt;UserName&lt;/key&gt;\n&lt;string&gt;carolclark&lt;/string&gt;</span></li>
			<li>copy file jetbrains.teamcity.server.plist to /Library/LaunchDaemons</li>
			<li>restart computer</li>
			<li class="blurb">Safari: localhost:8111 should show TeamCity window</li>
		</ul></li>
		<li>see <a href="https://confluence.jetbrains.com/display/TCD10/Installing+and+Configuring+the+TeamCity+Server#InstallingandConfiguringtheTeamCityServer-TroubleshootingTeamCityInstallation">
			Troubleshooting TeamCity Installation</a> if needed</li>
		<li><em><span style="color: crimson">CLOSE</span> the TeamCity window to the web application</em></li>
	</ul>

	<!-- @marker "Create TeamCityDB" -->
	<h4 id='CreateTeamCityDB_'>Create TeamCityDB</h4><ul>
		<li>create TeamCity database<ul>
			<li><a href="../Support/MySQL.html#CreateDatabase_">create</a> MySQL database TeamCityDB with user carolclark</li>
		</ul></li>
		<li>prevent creation of dummy admin user: add "teamcity.installation.completed=true" to &lt;TeamCity Home Directory&gt;/conf/teamcity-startup.properties</li>
	</ul>

	<!-- @marker "Integrate MySQL and TeamCity Servers" -->
	<h4 id='IntegrateMySQLandTeamCityServers_'>Integrate MySQL and TeamCity Servers</h4><ul>
		<li>MySQL server side<ul>
			<li class="blurb">see<a href="https://confluence.jetbrains.com/pages/viewpage.action?pageId=74845225#HowTo...-ConfigureNewlyInstalledMySQLServer">
			Configure Newly Installed MySQL Server</a></li>
			<li>locate file my.cnf; see <a href="http://dev.mysql.com/doc/refman/5.5/en/option-files.html">Using Option Files</a></li>
			<li>verify MySQL is using InnoDB database engine: mysql: <a class="mono">show table status like '%';</a></li>
			<li>edit TeamCityDB configuration file my.cnf<ul>
				<li>set memory allocation: <span class="mono">preset TEAMCITY_SERVER_MEM_OPTS=-Xmx750m</span><ul>
					<li class="blurb">For small system not adjusted for compatibility with 64-bit Java, recommendation is 750m (-Xmx750m).
						Since we have a very small system, we expect 750m to be fine.</li>
					<li>reference: <a href="https://confluence.jetbrains.com/display/TCD10/Installing+and+Configuring+the+TeamCity+Server#InstallingandConfiguringtheTeamCityServer-SettingUpMemorysettingsforTeamCityServer">
						Setting Up Memory Settings for TeamCity server</a></li>
				</ul></li>
				<li>configure InnoDB database engine<ul>
					<li>innodb_buffer_pool_size, innodb_log_file_size: <span class="mono">innodb_buffer_pool_size=2000M; innodb_log_file_size=1000M</span></li>
					<li>ensure <a class="mono">max_connections</a> parameter is larger than specified by TeamCity &lt;TeamCity data directory&gt;/config/database.properties</li>
					<li>adjust flushing for better performance: <span class="mono">innodb_flush_log_at_trx_commit=2</span></li>
				</ul></li>
				<li>set binary logging format: <span class="mono">binlog-format=mixed</span> </li>
			</ul></li>
			<li>enable additional diagnostics: <span class="mono">mysql: GRANT PROCESS ON *.* TO &lt;teamcity-user-name&gt;;</span></li>
		</ul></li>
		<li>TeamCity server side<ul>
			<li>install <a href="Tools.html#_Connector_J">Tools: Connector/J</a></li>
		</ul></li>
	</ul>

	<!-- @marker "Run and Configure TeamCity WebApp" -->
	<h4 id='RunTeamCityWebApp_'>Run TeamCity WebApp and Configure</h4><ul>
		<li class="blurb">update this section as we go</li>
		<li>TeamCity data path: /Volumes/TeamCity/.BuildServer</li>
		<li>user: carolclark; password</li>
		<li>profile page: user name and email</li>
		<li>UISettings: Highlight my changes and investigations: ON; Show date/time in my timezone: turn ON;
			Show all personal builds: turn ON; Add builds triggered by me to favorites: ON (experiment)</li>
	</ul>

	<!-- @marker "Install Build Agent" -->
	<h4 id='InstallBuildAgent_'>Install Build Agent</h4><ul>
		<li class="blurb">see <a href="https://confluence.jetbrains.com/display/TCD10/Setting+up+and+Running+Additional+Build+Agents#SettingupandRunningAdditionalBuildAgents-InstallingviaZIPFile">
			Setting up and Running Additional Build Agents: Installing via ZIP file</a></li>
		<li>TeamCity Web UI &gt; Agents tab &gt; Install Build Agents &gt; Zip file distribution</li>
		<li>unzip into /Volumes/TeamCity/BuildAgent-&lt;n&gt;</li>
		<li>/Volumes/TeamCity/BuildAgent-&lt;n&gt;/conf/ file buildAgent.dist.properties: rename to buildAgent.properties</li>
		<li>edit buildAgent.properties<ul>
			<li>serverUrl=http://localhost:8111/</li>
			<li>name=BuildAgent-&lt;n&gt;</li>
		</ul></li>
		<li>specify unique label:&nbsp;&nbsp;<span class='mono'><span class="prompt">$ </span>bin/jetbrains.teamcity.BuildAgent.plist: Label: jetbrains.teamcity.BuildAgent-&lt;n&gt;</span></li>

		<li class="dq">make sure that all files under the buildAgent directory are owned by carolclark</li>
		<li>create directory under carolclark/user for BuildAgent logs:&nbsp;&nbsp;<span class='mono'><span class="prompt">$ </span>mkdir buildAgent/logs</span></li>
		<li>load build agent<ul>
			<li>first agent:&nbsp;&nbsp;<span class='mono'><span class="prompt">$ </span>sh buildAgent/bin/mac.launchd.sh load</span></li>
			<li>additional agents:&nbsp;&nbsp;<span class='mono'><span class="prompt">$ </span>sh (buildAgent?)/bin/agent.sh load</span></li>
		</ul></li>
		<li>wait a few minutes; watch for <span class="mono">(tail) -f buildAgent/logs/teamcity-agent.log</span></li>
		<li>stop build server:&nbsp;&nbsp;<span class='mono'><span class="prompt">$ </span>sh buildAgent/bin/mac.launchd.sh unload</span></li>
		<li>configure build server to start automatically, but not on system startup:&nbsp;&nbsp;<span class='mono'><span class="prompt">$ </span>
		 cp buildAgent/bin/jetbrains.teamcity.BuildAgent.plist $HOME/Library/LaunchAgents/; rename file to ...BuildAgent-&lt;n&gt;</span></li>
		<li>reboot: build user should be logged in, and the build agent should start</li>
	</ul>

	<!-- @marker "Store Project Settings in Version Control" -->
	<h4 id='StoreProjectSettingsinVCS_'>Store Project Settings in Version Control</h4><ul>
		<li><a href="https://confluence.jetbrains.com/display/TCD10/Storing+Project+Settings+in+Version+Control">
			Store Project Settings in Version Control</a></li>
	</ul>

<!-- @marker "TeamCity Tasks" -->
<h3 id='TeamCityTasks_'>TeamCity Tasks</h3>

	<!-- @marker "Moving to Another Server" -->
	<h4 id='MovingServer_'>Moving Projects to Another Server</h4><ul>
		<li>make standard TeamCity backups of existing projects</li>
		<li>see <a href="https://confluence.jetbrains.com/display/TCD9/Projects+Import">Project Import</a> to import into new server</li>
	</ul>

	<!-- @marker "Uninstall TeamCity" -->
	<h4 id='UninstallTeamCity_'>Uninstall TeamCity</h4><ul>
		<li>quit TeamCity</li>
		<li>from /Library/LaunchDeamons, delete jetbrains.teamcity.server.plist</li>
		<li>Activity Monitor: terminate any active TeamCity process(es)<ul>
			<li>open Activity Monitor; show all process</li>
			<li>look through list; for any associated with TeamCity, 'quit' using button at top left</li>
		</ul></li>
		<li>delete TeamCity application (a Library or Applications folder)</li>
		<li>delete /Application Support/TeamCityIntegration</li>
		<li>delete BuildServer data (/Volumes/TeamCity/TeamCityDB/.BuildServer or ~/.BuildServer)</li>
		<li>look in user and top-level folders "Application Support", Preferences, Caches for files to delete</li>
	</ul>

<p><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
	<br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
	<br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
	<br /><br /><br /><br /><br /><br /><br /><br /><br /><br /></p>
<hr class='footer' />
<p class='footer'>Copyright (c) 2016 C &amp; C Software, Inc. All rights reserved.</p>
</body>
</html>
